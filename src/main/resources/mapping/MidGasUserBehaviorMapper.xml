<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zkpt.data.dao.GasUserBehaviorMapper">
	<resultMap id="BaseResultMap" type="com.zkpt.data.entity.GasUserBehavior">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		<id column="ID" property="id" jdbcType="INTEGER" />
		<result column="OPERTION_ID" property="opertionId" jdbcType="INTEGER" />
		<result column="BANK_DEVICE_ID" property="bankDeviceId" jdbcType="INTEGER" />
		<result column="USER_NO" property="userNo" jdbcType="VARCHAR" />
		<result column="VALUE1" property="value1" jdbcType="VARCHAR" />
		<result column="VALUE2" property="value2" jdbcType="VARCHAR" />
		<result column="VALUE3" property="value3" jdbcType="VARCHAR" />
		<result column="VALUE4" property="value4" jdbcType="VARCHAR" />
		<result column="VALUE5" property="value5" jdbcType="VARCHAR" />
		<result column="CREATE_BY" property="createBy" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
		<result column="UPDATE_BY" property="updateBy" jdbcType="VARCHAR" />
		<result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP" />
		<result column="DELFLAG" property="delflag" jdbcType="SMALLINT" />
		<result column="DEL_DATE" property="delDate" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="PaymentBaseResultMap" type="com.zkpt.data.view.UserPaymentView">
		<id column="ID" property="id" jdbcType="INTEGER" />
		<result column="TRANSACTION_FLOW" property="transactionFlow" jdbcType="VARCHAR" />
		<result column="PAYMENT_SUM" property="paymentSum" jdbcType="VARCHAR" />
		<result column="OPERATION_NO" property="operatorNo" jdbcType="VARCHAR" />
		<result column="MONTH" property="month" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="StreamBaseResultMap" type="com.zkpt.data.view.StreamView">
		<id column="ID" property="id" jdbcType="INTEGER" />
		<result column="USER_NO" property="userNo" jdbcType="VARCHAR" />
		<result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
		<result column="TRANSACTION_FLOW" property="transactionFlow" jdbcType="VARCHAR" />
		<result column="VALUE" property="value" jdbcType="VARCHAR" />
		<result column="BANK_COMMAND" property="bankCommand" jdbcType="VARCHAR" />
		<result column="BANK_COMMAND_NAME" property="bankCommandName" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
	</resultMap>

	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		ID, OPERTION_ID, BANK_DEVICE_ID, USER_NO, VALUE1, VALUE2,
		VALUE3,
		VALUE4, VALUE5,
		CREATE_BY, CREATE_DATE,
		UPDATE_BY,
		UPDATE_DATE,
		DELFLAG,
		DEL_DATE
	</sql>

	<sql id="PaymentBase_Column_List">
		b.ID, b.VALUE1 TRANSACTION_FLOW, b.VALUE2 PAYMENT_SUM, b.VALUE3 OPERATION_NO, if(b.VALUE4 = '000000',
		'全额缴费', b.VALUE4) MONTH,
		b.CREATE_DATE
	</sql>

	<sql id="StreamBase_Column_List">
		b.ID, b.USER_NO, u.USER_NAME,b.VALUE1 TRANSACTION_FLOW, b.VALUE2 VALUE,o.BANK_COMMAND,t.typename
		BANK_COMMAND_NAME,
		b.CREATE_DATE
	</sql>

	<select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from mid_gas_user_behavior
		where ID = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		delete from mid_gas_user_behavior
		where ID = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.zkpt.data.entity.GasUserBehavior" useGeneratedKeys="true"
		keyProperty="id" keyColumn="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		insert into mid_gas_user_behavior (ID, OPERTION_ID, BANK_DEVICE_ID,
		USER_NO, VALUE1, VALUE2,
		VALUE3, VALUE4, VALUE5,
		CREATE_BY,
		CREATE_DATE,
		UPDATE_BY, UPDATE_DATE, DELFLAG,
		DEL_DATE)
		values
		(#{id,jdbcType=INTEGER},
		#{opertionId,jdbcType=INTEGER},
		#{bankDeviceId,jdbcType=INTEGER},
		#{userNo,jdbcType=VARCHAR},
		#{value1,jdbcType=VARCHAR}, #{value2,jdbcType=VARCHAR},
		#{value3,jdbcType=VARCHAR}, #{value4,jdbcType=VARCHAR},
		#{value5,jdbcType=VARCHAR}, #{createBy,jdbcType=VARCHAR},
		#{createDate,jdbcType=TIMESTAMP},
		#{updateBy,jdbcType=VARCHAR},
		#{updateDate,jdbcType=TIMESTAMP}, #{delflag,jdbcType=SMALLINT},
		#{delDate,jdbcType=TIMESTAMP})
	</insert>
	<insert id="insertSelective" parameterType="com.zkpt.data.entity.GasUserBehavior">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		insert into mid_gas_user_behavior
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				ID,
			</if>
			<if test="opertionId != null">
				OPERTION_ID,
			</if>
			<if test="bankDeviceId != null">
				BANK_DEVICE_ID,
			</if>
			<if test="userNo != null">
				USER_NO,
			</if>
			<if test="value1 != null">
				VALUE1,
			</if>
			<if test="value2 != null">
				VALUE2,
			</if>
			<if test="value3 != null">
				VALUE3,
			</if>
			<if test="value4 != null">
				VALUE4,
			</if>
			<if test="value5 != null">
				VALUE5,
			</if>
			<if test="createBy != null">
				CREATE_BY,
			</if>
			<if test="createDate != null">
				CREATE_DATE,
			</if>
			<if test="updateBy != null">
				UPDATE_BY,
			</if>
			<if test="updateDate != null">
				UPDATE_DATE,
			</if>
			<if test="delflag != null">
				DELFLAG,
			</if>
			<if test="delDate != null">
				DEL_DATE,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="opertionId != null">
				#{opertionId,jdbcType=INTEGER},
			</if>
			<if test="bankDeviceId != null">
				#{bankDeviceId,jdbcType=INTEGER},
			</if>
			<if test="userNo != null">
				#{userNo,jdbcType=VARCHAR},
			</if>
			<if test="value1 != null">
				#{value1,jdbcType=VARCHAR},
			</if>
			<if test="value2 != null">
				#{value2,jdbcType=VARCHAR},
			</if>
			<if test="value3 != null">
				#{value3,jdbcType=VARCHAR},
			</if>
			<if test="value4 != null">
				#{value4,jdbcType=VARCHAR},
			</if>
			<if test="value5 != null">
				#{value5,jdbcType=VARCHAR},
			</if>
			<if test="createBy != null">
				#{createBy,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null">
				#{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="updateBy != null">
				#{updateBy,jdbcType=VARCHAR},
			</if>
			<if test="updateDate != null">
				#{updateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="delflag != null">
				#{delflag,jdbcType=SMALLINT},
			</if>
			<if test="delDate != null">
				#{delDate,jdbcType=TIMESTAMP},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.zkpt.data.entity.GasUserBehavior">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		update mid_gas_user_behavior
		<set>
			<if test="opertionId != null">
				OPERTION_ID = #{opertionId,jdbcType=INTEGER},
			</if>
			<if test="bankDeviceId != null">
				BANK_DEVICE_ID = #{bankDeviceId,jdbcType=INTEGER},
			</if>
			<if test="userNo != null">
				USER_NO = #{userNo,jdbcType=VARCHAR},
			</if>
			<if test="value1 != null">
				VALUE1 = #{value1,jdbcType=VARCHAR},
			</if>
			<if test="value2 != null">
				VALUE2 = #{value2,jdbcType=VARCHAR},
			</if>
			<if test="value3 != null">
				VALUE3 = #{value3,jdbcType=VARCHAR},
			</if>
			<if test="value4 != null">
				VALUE4 = #{value4,jdbcType=VARCHAR},
			</if>
			<if test="value5 != null">
				VALUE5 = #{value5,jdbcType=VARCHAR},
			</if>
			<if test="createBy != null">
				CREATE_BY = #{createBy,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null">
				CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="updateBy != null">
				UPDATE_BY = #{updateBy,jdbcType=VARCHAR},
			</if>
			<if test="updateDate != null">
				UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="delflag != null">
				DELFLAG = #{delflag,jdbcType=SMALLINT},
			</if>
			<if test="delDate != null">
				DEL_DATE = #{delDate,jdbcType=TIMESTAMP},
			</if>
		</set>
		where ID = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.zkpt.data.entity.GasUserBehavior">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. -->
		update mid_gas_user_behavior
		set OPERTION_ID =
		#{opertionId,jdbcType=INTEGER},
		BANK_DEVICE_ID =
		#{bankDeviceId,jdbcType=INTEGER},
		USER_NO = #{userNo,jdbcType=VARCHAR},
		VALUE1 = #{value1,jdbcType=VARCHAR},
		VALUE2 =
		#{value2,jdbcType=VARCHAR},
		VALUE3 = #{value3,jdbcType=VARCHAR},
		VALUE4
		= #{value4,jdbcType=VARCHAR},
		VALUE5 =
		#{value5,jdbcType=VARCHAR},
		CREATE_BY = #{createBy,jdbcType=VARCHAR},
		CREATE_DATE =
		#{createDate,jdbcType=TIMESTAMP},
		UPDATE_BY =
		#{updateBy,jdbcType=VARCHAR},
		UPDATE_DATE =
		#{updateDate,jdbcType=TIMESTAMP},
		DELFLAG =
		#{delflag,jdbcType=SMALLINT},
		DEL_DATE = #{delDate,jdbcType=TIMESTAMP}
		where ID = #{id,jdbcType=INTEGER}
	</update>

	<!-- 查询指定用户所有的缴费记录 -->
	<select id="findUserAllPayment" resultMap="PaymentBaseResultMap">
		SELECT
			<include refid = "PaymentBase_Column_List" />
		FROM
			mid_gas_user_behavior b
		JOIN mid_operation o ON b.OPERTION_ID = o.ID
		WHERE
			USER_NO = #{userNo,jdbcType=VARCHAR}
		AND o.STATE = 'S'
		AND o.BANK_COMMAND = 821
		ORDER BY
			b.ID DESC
	</select>

	<!-- 查询所有的交易流水 -->
	<select id="findAllStream" resultMap="StreamBaseResultMap" parameterType="com.zkpt.data.view.StreamView">
		SELECT
			<include refid = "StreamBase_Column_List" />
		FROM
			mid_gas_user_behavior b
		JOIN mid_operation o ON b.OPERTION_ID = o.ID AND (o.BANK_COMMAND = 850 OR o.BANK_COMMAND = 821)
		JOIN mid_gas_user u ON b.USER_NO = u.USER_NO
		JOIN t_s_type t ON o.BANK_COMMAND = t.typecode
		JOIN t_s_typegroup p ON t.typegroupid = p.ID
		AND p.typegroupcode = 'protocol.command'
		WHERE
			o.STATE = 'S'
		AND (
			o.BANK_COMMAND = 850
			OR o.BANK_COMMAND = 821
		)
		<if test="userNo != null and userNo != ''">AND u.USER_NO like CONCAT(CONCAT('%', #{userNo,jdbcType=VARCHAR},'%'))</if>
		<if test="userName != null and userName != ''">AND u.USER_NAME like CONCAT(CONCAT('%', #{userName,jdbcType=VARCHAR},'%'))</if>
		<if test="createDate != null">AND b.CREATE_DATE = #{createDate, jdbcType=DATE}</if>
		<if test="bankCommand != null and bankCommand != -1">AND o.BANK_COMMAND = #{bankCommand,jdbcType=VARCHAR}</if>
		<if test="value != null and value != ''">AND b.VALUE2 = #{value,jdbcType=VARCHAR}</if>
		ORDER BY b.ID DESC
	</select>
	
	<!-- 查询昨日所有用户的缴费及查询记录(value5是缴费方式, value2是欠费金额, value3是欠费月份) -->
	<select id="findAllYesterdayStream" resultMap="BaseResultMap">
		SELECT
			b.USER_NO, b.VALUE5, c.VALUE2, c.VALUE3
		FROM
			mid_gas_user_behavior b
		JOIN mid_operation o ON b.OPERTION_ID = o.ID AND o.BANK_COMMAND = 821 AND DATEDIFF(NOW(), o.CREATE_DATE) = 1
		JOIN (SELECT DISTINCT b.USER_NO, b.VALUE2, b.VALUE3 FROM mid_gas_user_behavior b JOIN mid_operation o ON b.OPERTION_ID = o.ID AND o.BANK_COMMAND = 811 AND DATEDIFF(NOW(), o.CREATE_DATE) = 1) c ON b.USER_NO = c.USER_NO
	</select>
</mapper>